#!/usr/bin/env bash

set -u

time="$(date +%Y-%m-%d-%H-%M-%S)"
geometry="$(xrandr | awk '/current/{print $8"x"$10; exit}' | tr -d ',')"
dir="$(xdg-user-dir PICTURES 2>/dev/null || echo "$HOME/Pictures")/Screenshots"
file="Screenshot_${time}_${geometry}.png"
out="${dir}/${file}"
notify_cmd='dunstify -u low -h string:x-dunst-stack-tag:obscreenshot -i /usr/share/icons/dunst/picture.png'

mkdir -p "$dir"

open_viewer() {
  if command -v loupe >/dev/null 2>&1; then
    loupe "$out" >/dev/null 2>&1 &
  elif command -v viewnior >/dev/null 2>&1; then
    viewnior "$out" >/dev/null 2>&1 &
  elif command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$out" >/dev/null 2>&1 &
  fi
}

capture_png() {
  local tmp
  tmp="$(mktemp /tmp/i3-shot-XXXXXX.png)"

  if "$@" >"$tmp" && [[ -s "$tmp" ]]; then
    mv "$tmp" "$out"
    if command -v xclip >/dev/null 2>&1; then
      xclip -selection clipboard -t image/png <"$out" >/dev/null 2>&1
    fi
    return 0
  fi

  rm -f "$tmp"
  return 1
}

notify_success() {
  ${notify_cmd} "Copied to clipboard."
  paplay /usr/share/sounds/freedesktop/stereo/screen-capture.oga >/dev/null 2>&1 &
  open_viewer
  ${notify_cmd} "Screenshot Saved."
}

notify_cancel() {
  dunstify -u low -h string:x-dunst-stack-tag:obscreenshot "Screenshot canceled."
}

countdown() {
  local sec
  for sec in $(seq "$1" -1 1); do
    dunstify -t 1000 -h string:x-dunst-stack-tag:screenshottimer -i /usr/share/icons/dunst/timer.png "Taking shot in: $sec"
    sleep 1
  done
}

shot_now() {
  capture_png maim -u -f png && notify_success || notify_cancel
}

shot_5() {
  countdown 5
  capture_png maim -u -f png && notify_success || notify_cancel
}

shot_10() {
  countdown 10
  capture_png maim -u -f png && notify_success || notify_cancel
}

shot_win() {
  local win_id
  win_id="$(xdotool getactivewindow 2>/dev/null || true)"
  [[ -n "$win_id" ]] || { notify_cancel; return; }
  capture_png maim -u -f png -i "$win_id" && notify_success || notify_cancel
}

shot_area() {
  capture_png maim -u -f png -s -b 2 -c 0.35,0.55,0.85,0.25 -l && notify_success || notify_cancel
}

case "${1:-}" in
  --now) shot_now ;;
  --in5) shot_5 ;;
  --in10) shot_10 ;;
  --win) shot_win ;;
  --area) shot_area ;;
  *) echo "Available options: --now --in5 --in10 --win --area" ;;
esac
