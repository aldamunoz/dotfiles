#!/usr/bin/env bash

##
## i3 Autostart Script (WM-only, DE-agnostic)

set -e

# i3 config directory
idir="$HOME/.config/i3"

# Export desktop session
export XDG_CURRENT_DESKTOP=i3
export XDG_SESSION_DESKTOP=i3

# --------------------------------------------------
# Helpers
# --------------------------------------------------

kill_safe() {
  local process="$1"
  if pgrep -x "$process" &>/dev/null; then
    echo "Stopping $process..."
    pkill "$process"
  fi
}

command_exists() {
  command -v "$1" &>/dev/null
}

start_once() {
  local process="$1"
  shift
  if ! pgrep -x "$process" &>/dev/null; then
    "$@" &
    echo "$process started."
  fi
}

# --------------------------------------------------
# Clean up previous instances (for i3 reload)
# --------------------------------------------------

processes_to_kill=(
  xsettingsd
  ksuperkey
  xfce-polkit
  polkit-gnome-authentication-agent-1
  xss-lock
  dunst
)

for process in "${processes_to_kill[@]}"; do
  kill_safe "$process"
done

# --------------------------------------------------
# GNOME Keyring (libsecret provider)
# --------------------------------------------------

if command_exists gnome-keyring-daemon; then
  eval "$(
    gnome-keyring-daemon \
      --start \
      --components=secrets
  )"
  export SSH_AUTH_SOCK
  echo "gnome-keyring (secrets) started."
fi

# Make keyring visible to apps
dbus-update-activation-environment DISPLAY XAUTHORITY XDG_CURRENT_DESKTOP

# --------------------------------------------------
# Polkit agent
# --------------------------------------------------

start_once \
  polkit-gnome-authentication-agent-1 \
  /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1

# --------------------------------------------------
# Super key helper
# --------------------------------------------------

if command_exists ksuperkey; then
  start_once ksuperkey ksuperkey -e 'Super_L=Alt_L|F1'
  start_once ksuperkey ksuperkey -e 'Super_R=Alt_L|F1'
fi

# --------------------------------------------------
# Cursor
# --------------------------------------------------

command_exists xsetroot && xsetroot -cursor_name left_ptr

# --------------------------------------------------
# Wallpaper
# --------------------------------------------------

if command_exists xwallpaper; then
  xwallpaper --zoom "$idir/wallpapers/endeavour.png"
fi

# Launch dunst daemon
if command_exists dunst; then
  start_once dunst &
fi
# --------------------------------------------------
# Notifications, bar, compositor
# --------------------------------------------------

for script in i3_bar i3_comp; do
  script_path="$idir/scripts/$script"
  [[ -x "$script_path" ]] && "$script_path" &
done

# --------------------------------------------------
# Lock screen on suspend
# --------------------------------------------------

if command_exists xss-lock && command_exists betterlockscreen; then
  xss-lock -- betterlockscreen -l &
  echo "xss-lock + betterlockscreen enabled."
fi

echo "i3 environment setup complete."
